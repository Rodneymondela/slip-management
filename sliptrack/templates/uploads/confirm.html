{% extends 'base.html' %}

{% block title %}Confirm Details - SlipTrack{% endblock %}

{% block content %}
<div>
  <h2 class="text-3xl font-extrabold text-gray-900">Confirm Details</h2>
  <p class="mt-2 text-sm text-gray-600">
    Review the details extracted from your document and make any necessary corrections.
  </p>
</div>

<div class="mt-8 lg:grid lg:grid-cols-3 lg:gap-8">
  <!-- Left column: Image preview -->
  <div class="lg:col-span-1">
    <div class="bg-white shadow rounded-lg overflow-hidden">
      {% if doc and doc.thumbnail_path %}
        {% set static_rel = doc.thumbnail_path.split('static/')[-1] %}
        <img src="{{ url_for('static', filename=static_rel) }}" alt="Document preview" class="w-full h-auto object-contain">
      {% else %}
        <div class="p-8 text-center text-gray-500">
          <p>No preview available</p>
        </div>
      {% endif %}
    </div>
    {% if doc %}
    <p class="text-xs text-gray-500 mt-2 break-all">
        Source: <a href="{{ url_for('static', filename=doc.file_path.split('static/')[-1]) if 'static/' in doc.file_path else doc.file_path }}" target="_blank" class="hover:underline">{{ doc.file_path.split('/')[-1] }}</a>
    </p>
    {% endif %}
  </div>

  <!-- Right column: Form -->
  <div class="mt-8 lg:mt-0 lg:col-span-2">
    <form method="post" action="{{ url_for('uploads.confirm') }}" class="space-y-6" id="confirmForm">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="document_id" value="{{ doc.id }}">
      <input type="hidden" name="currency" value="ZAR">

      <div class="bg-white shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900">Supplier & Date</h3>
          <div class="mt-6 grid grid-cols-1 gap-6 sm:grid-cols-6">
            <div class="sm:col-span-3">
              <label for="supplier_name" class="block text-sm font-medium text-gray-700">Supplier</label>
              <input type="text" name="supplier_name" id="supplier_name" value="{{ parsed.get('supplier_name','') }}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
            </div>
            <div class="sm:col-span-3">
              <label for="entry_date" class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" name="entry_date" id="entry_date" value="{{ parsed.get('entry_date','') }}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
            </div>
             <div class="sm:col-span-3">
              <label for="reference_no" class="block text-sm font-medium text-gray-700">Reference / Invoice #</label>
              <input type="text" name="reference_no" id="reference_no" value="{{ parsed.get('reference_no','') }}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
            </div>
            <div class="sm:col-span-3">
              <label for="supplier_vat_number" class="block text-sm font-medium text-gray-700">Supplier VAT Number</label>
              <input type="text" name="supplier_vat_number" id="supplier_vat_number" value="{{ parsed.get('supplier_vat_number','') }}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
            </div>
          </div>
        </div>
      </div>

      <div class="bg-white shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Financials</h3>
            <div class="mt-6 grid grid-cols-1 gap-6 sm:grid-cols-6">
                <div class="sm:col-span-2">
                    <label for="subtotal" class="block text-sm font-medium text-gray-700">Subtotal (R)</label>
                    <input type="number" name="subtotal" id="subtotal" value="{{ parsed.get('subtotal','') }}" step="0.01" inputmode="decimal" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div class="sm:col-span-2">
                    <label for="vat_amount" class="block text-sm font-medium text-gray-700">VAT Amount (R)</label>
                    <input type="number" name="vat_amount" id="vat_amount" value="{{ parsed.get('vat_amount','') }}" step="0.01" inputmode="decimal" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div class="sm:col-span-2">
                    <label for="total_amount" class="block text-sm font-medium text-gray-700">Total (R)</label>
                    <input type="number" name="total_amount" id="total_amount" value="{{ parsed.get('total_amount','') }}" step="0.01" inputmode="decimal" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
                </div>
                <div class="sm:col-span-6">
                    <div class="flex items-center">
                        <input id="vat_included" name="vat_included" type="checkbox" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded" checked>
                        <label for="vat_included" class="ml-2 block text-sm text-gray-900">
                          VAT included (rate:
                          <input id="vat_rate" name="vat_rate" type="number" step="0.01" class="inline-block w-20 border-gray-300 rounded-md shadow-sm sm:text-sm" value="{{ parsed.get('vat_rate', 0.15) }}">)
                        </label>
                    </div>
                </div>
            </div>
        </div>
      </div>

      <div class="bg-white shadow sm:rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-gray-900">Categorization</h3>
          <div class="mt-6 grid grid-cols-1 gap-6 sm:grid-cols-6">
            <div class="sm:col-span-3">
                <label for="category" class="block text-sm font-medium text-gray-700">Category</label>
                <input type="text" name="category" id="category" value="{{ parsed.get('category','') }}" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">
            </div>
            <div class="sm:col-span-3">
                <label for="payment_method" class="block text-sm font-medium text-gray-700">Payment Method</label>
                <select id="payment_method" name="payment_method" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm rounded-md">
                    {% set pm = parsed.get('payment_method','unknown') %}
                    <option value="unknown" {{ 'selected' if pm=='unknown' else '' }}>Unknown</option>
                    <option value="cash" {{ 'selected' if pm=='cash' else '' }}>Cash</option>
                    <option value="card" {{ 'selected' if pm=='card' else '' }}>Card</option>
                    <option value="eft"  {{ 'selected' if pm=='eft'  else '' }}>EFT</option>
                </select>
            </div>
            <div class="sm:col-span-6">
                <label for="notes" class="block text-sm font-medium text-gray-700">Notes</label>
                <textarea id="notes" name="notes" rows="3" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary sm:text-sm">{{ parsed.get('notes','') }}</textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="flex justify-end pt-2 space-x-3">
        <a href="{{ url_for('journal.list_journal') }}" class="bg-white py-2 px-4 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
          Cancel
        </a>
        <button type="submit" class="inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
          Save to Journal
        </button>
      </div>
    </form>
  </div>
</div>

<script>
// Simple VAT auto-calc if "VAT included" is ticked.
function parseNum(v) {
  if (v === null || v === undefined || v === '') return NaN;
  return parseFloat(String(v).replace(',', '.'));
}
function toMoney(n) {
  if (!isFinite(n)) return '';
  return (Math.round(n * 100) / 100).toFixed(2);
}

const totalEl = document.getElementById('total_amount');
const rateEl  = document.getElementById('vat_rate');
const chkIncl = document.getElementById('vat_included');
const subtotalEl = document.getElementById('subtotal');
const vatAmountEl = document.getElementById('vat_amount');

function recalc() {
  const total = parseNum(totalEl.value);
  const rate  = parseNum(rateEl.value);
  if (!chkIncl.checked || !isFinite(total) || !isFinite(rate)) return;
  const base = total / (1 + rate);
  const vat  = total - base;
  subtotalEl.value = toMoney(base);
  vatAmountEl.value = toMoney(vat);
}

totalEl?.addEventListener('input', recalc);
rateEl?.addEventListener('input', recalc);
chkIncl?.addEventListener('change', recalc);
</script>
{% endblock %}