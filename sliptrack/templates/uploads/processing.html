{% extends "base.html" %}

{% block title %}Processing Document{% endblock %}

{% block content %}
<div class="container mx-auto mt-10 text-center">
    <h1 class="text-2xl font-bold mb-4">We're processing your document!</h1>
    <p class="text-gray-600 mb-6">Please wait a moment. This page will automatically redirect you when it's ready.</p>

    <div id="spinner" class="flex items-center justify-center space-x-2">
        <div class="w-8 h-8 border-4 border-blue-500 border-solid rounded-full animate-spin border-t-transparent"></div>
        <span class="text-lg">Processing...</span>
    </div>

    <div id="status-container" data-task-id="{{ doc.task_id }}" data-doc-id="{{ doc.id }}"></div>

    <div id="error-message" class="hidden mt-6 p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <p class="font-bold">An error occurred:</p>
        <p id="error-text"></p>
        <a href="{{ url_for('uploads.confirm_get', doc_id=doc.id) }}" class="mt-2 inline-block text-blue-500 hover:underline">Please try filling it out manually.</a>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusContainer = document.getElementById('status-container');
    const docId = statusContainer.dataset.docId;

    if (!docId) {
        console.error('No document ID found.');
        return;
    }

    const pollStatus = () => {
        fetch(`/uploads/doc_status/${docId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else if (data.doc_status === 'ocr_failed') {
                    document.getElementById('spinner').classList.add('hidden');
                    const errorDiv = document.getElementById('error-message');
                    const errorText = document.getElementById('error-text');
                    errorText.textContent = data.error || 'Document processing failed. The image may be blurry or unreadable.';
                    errorDiv.classList.remove('hidden');
                } else if (data.doc_status === 'processing' || data.doc_status === 'pending') {
                    setTimeout(pollStatus, 2500); // Poll again
                } else {
                    // Unhandled status, show a generic error
                    throw new Error(`Unhandled document status: ${data.doc_status}`);
                }
            })
            .catch(err => {
                console.error('Error polling document status:', err);
                document.getElementById('spinner').classList.add('hidden');
                const errorDiv = document.getElementById('error-message');
                const errorText = document.getElementById('error-text');
                errorText.textContent = 'Could not check the processing status. Please refresh the page or check the journal later.';
                errorDiv.classList.remove('hidden');
            });
    };

    pollStatus();
});
</script>
{% endblock %}